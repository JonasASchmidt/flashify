<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Flashify your image ...</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --drop-margin:24px;
    --drop-radius:48px;
    --drawer-inset:32px;
    --drawer-pad:32px;
    --border-w:4px; --dash-l:16px; --gap-l:16px;
    --stroke-normal:.25; --stroke-hover:.5;
    --btn-h:52px; --btn-fs:20px; --btn-pad-x:24px;
    --t-sync:.125s; --range-w:128px;
    --cols-gap:36px; --group-gap:12px;
  }

  @media (max-width: 420px){
    :root{
      --drop-margin:12px;
      --drop-radius:40px;
      --drawer-inset:14px;    /* +8px vs vorher */
      --drawer-pad:28px;      /* +12px vs vorher */
      --btn-h:46px; --btn-fs:18px; --btn-pad-x:18px;
      --range-w:112px;
      --cols-gap:24px;
      --group-gap:36px;       /* vertikaler Abstand zw. Gruppen */
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:"Funnel Display",Helvetica,"Helvetica Neue",Arial,sans-serif;
    background:#040915;color:#fff;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  button,input,select,textarea{font-family:inherit}
  .nowrap{white-space:nowrap;display:inline}
  .emoji{display:inline;vertical-align:baseline}

  .drop{
    position:fixed;
    inset:var(--drop-margin);
    display:grid; place-items:center;
    border-radius:var(--drop-radius);
    overflow:hidden; cursor:pointer; isolation:isolate;
    transition:filter var(--t-sync) ease-in-out;
  }
  .drop:hover{filter:brightness(1.06)}
  .drop.flash::after{content:"";position:absolute;inset:0;border-radius:inherit;background:#fff;opacity:0;pointer-events:none;animation:flash .45s ease}
  @keyframes flash{0%{opacity:1}100%{opacity:0}}

  .bg{position:absolute;inset:0;z-index:0;pointer-events:none}
  .bg>*{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
  .bg::after{content:"";position:absolute;inset:0;background:transparent;transition:background var(--t-sync) ease-in-out}
  .drop.processing .bg::after{background:rgba(0,0,0,.22)}
  #ph,#live{width:100%;height:100%;object-fit:cover}
  #ph{opacity:0;transition:opacity var(--t-sync) ease-in-out}
  #ph.show{opacity:1} #ph.hide{opacity:0}

  .center{
    position:relative; z-index:2; text-align:center; pointer-events:none;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px;
    transition:opacity var(--t-sync) ease-in-out,transform var(--t-sync) ease-in-out;
    max-width:92%;
    padding-top:36px; padding-bottom:36px; /* Mindestabstand Top/Bottom */
  }
  h1{
    margin:0; padding:0 4px;  /* etwas weniger horizontaler Puffer f√ºr Fits */
    font-weight:800; letter-spacing:.2px;
    font-size:clamp(28px,6vw,54px); line-height:1.06;
    text-shadow:0 2px 16px rgba(0,0,0,.45);
    -webkit-hyphens:none; hyphens:none; word-break:normal; overflow-wrap:normal;
    max-width:94%;           /* mehr nutzbare Breite gegen Umbruch */
  }
  /* Mobile Basis */
  @media (max-width:420px){
    .center{max-width:98%}   /* mehr Breite f√ºr √úberschrift */
    h1{ font-size:clamp(34px,9.6vw,64px); max-width:98%; }
  }
  /* Mobile Portrait ‚Äì **reduziert auf 0.75** der fr√ºheren 1.75x-Gr√∂√üe */
  @media (max-width:420px) and (orientation:portrait){
    /* vorher: clamp(60px,18vw,108px) ‚Üí jetzt *0.75 */
    h1{ font-size:clamp(45px,13.5vw,81px); }
  }

  .actions{display:flex;gap:8px;pointer-events:auto;transition:all var(--t-sync) ease-in-out;flex-wrap:wrap;justify-content:center}
  .hidden{display:none!important}

  .drop.processing .actions .btn,
  .drop.processing .menu .item{pointer-events:none;opacity:.6;filter:grayscale(.2)}
  .subline{font-size:20px;opacity:.9;pointer-events:auto;text-decoration:underline;cursor:pointer;color:#fff;transition:all var(--t-sync) ease-in-out}
  .subline:hover{color:#000} .subline.hidden{display:none}
  .drop.processing .subline{pointer-events:none;opacity:.6}

  .btn{appearance:none;border:0;border-radius:10px;height:var(--btn-h);padding:0 var(--btn-pad-x);font-weight:800;cursor:pointer;background:#000;color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:8px;white-space:nowrap;transition:all var(--t-sync) ease-in-out;font-size:var(--btn-fs)}
  .btn:active{transform:translateY(1px)}
  .btn .label{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:220% 220%;-webkit-background-clip:text;background-clip:text;color:transparent;display:inline-flex;align-items:center;transition:all var(--t-sync) ease-in-out}
  .btn:hover{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:240% 240%;color:#000}
  .btn:hover .label{background:none;color:#000}
  .btn[disabled]{opacity:.6;pointer-events:none}

  .btnGhost{background:transparent;border:1px solid rgba(255,255,255,.5);color:#fff;transition:all var(--t-sync) ease-in-out}
  .btnGhost .label{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:220% 220%;-webkit-background-clip:text;background-clip:text;color:transparent;transition:all var(--t-sync) ease-in-out}
  .btnGhost:hover{background:#fff;color:#000}
  .btnGhost:hover .label{background:none;color:#000}
  .btn--sm{height:36px;font-size:16px;padding:0 12px;border-radius:10px}

  .gradText{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:220% 220%;-webkit-background-clip:text;background-clip:text;color:transparent}

  .dots{display:inline;margin-left:.1em; white-space:nowrap} /* nie umbrechen */
  .dots span{display:inline;opacity:.25}
  @keyframes blinkDot{0%{opacity:.25}8%{opacity:1}20%{opacity:.25}100%{opacity:.25}}
  .busy .dots span{animation:blinkDot 1.05s infinite ease-in-out both}
  .busy .dots span:nth-child(2){animation-delay:.18s}
  .busy .dots span:nth-child(3){animation-delay:.36s}

  .menu{position:relative;pointer-events:auto}
  #chev.btn{padding:0 18px}.chev{font-weight:900}
  .menu .panel{
    position:absolute;left:50%;top:calc(100% + 8px);transform:translateX(-50%);
    z-index:5;display:none;flex-direction:column;gap:8px;
  }
  .menu.open .panel{display:flex}

  .menu .item{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:var(--btn-h);padding:0 var(--btn-pad-x);border-radius:10px;cursor:pointer;background:#000;color:#fff;transition:all var(--t-sync) ease-in-out;font-size:var(--btn-fs); border:0; white-space:nowrap}
  .menu .item .label{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:220% 220%;-webkit-background-clip:text;background-clip:text;color:transparent;transition:all var(--t-sync) ease-in-out}
  .menu .item:hover{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:240% 240%;color:#000}
  .menu .item:hover .label{background:none;color:#000}
  .menu .item:active{transform:translateY(1px)}

  /* **Mobile**: Panel mittig, Breite ans Viewport begrenzen, umbrechen, Sichtbarkeit in Landscape */
  @media (max-width: 420px){
    .menu .panel{
      left:50%; transform:translateX(-50%);
      width:auto; max-width:calc(100vw - 24px);
      padding:6px 0;
      max-height:50vh; overflow:auto;
      align-items:stretch;
    }
    .menu .item{
      width:100%;
      white-space:normal;          /* label darf umbrechen */
      text-align:center;
      line-height:1.15;
      padding-left:16px; padding-right:16px;
    }
  }
  @media (max-height:420px) and (orientation:landscape){
    .menu .panel{ max-height:60vh; }
  }

  .bottomUI{position:absolute;left:32px;right:32px;bottom:40px;z-index:4;display:flex;flex-direction:column;align-items:center;gap:8px}
  .feedback{display:flex;justify-content:center;align-items:center;gap:10px;pointer-events:auto;font-size:12px;opacity:.9}
  .iconbtn{background:transparent;border:0;cursor:pointer;line-height:1;padding:2px 3px;display:inline-flex;align-items:center;opacity:.55;transition:all var(--t-sync) ease-in-out}
  .iconbtn:hover{opacity:.85;transform:translateY(-1px)} .iconbtn.active{opacity:1}
  .iconbtn svg{width:12px;height:12px;display:block;fill:currentColor;color:#fff}

  .toast{display:none;opacity:0;transition:opacity var(--t-sync) ease-in-out; font-size:12px; background:rgba(0,0,0,.86); padding:16px 16px 12px; border-radius:8px; pointer-events:auto; position:relative}
  .toast.show{display:inline-block;opacity:1}
  .toast.narrow{width:min-content; max-width:90%}
  .toast .x{position:absolute;top:6px;right:8px;background:transparent;border:0;color:#fff;cursor:pointer;font-weight:800;line-height:1;transition:all var(--t-sync) ease-in-out}
  .toast .x:hover{opacity:.85;transform:rotate(6deg)}

  .frame{position:absolute;inset:0;z-index:3;pointer-events:none}
  .frame svg{width:100%;height:100%}
  .dashPath{fill:none;stroke:rgba(255,255,255,var(--stroke-normal));stroke-width:var(--border-w);stroke-linejoin:round;stroke-linecap:round;vector-effect:non-scaling-stroke;stroke-dasharray:var(--dash-l) var(--gap-l);transition:all var(--t-sync) ease-in-out}
  .drop:hover .dashPath{stroke:rgba(255,255,255,var(--stroke-hover))}.drop.ready:hover .dashPath{stroke:rgba(255,255,255,1)}
  .progressPath{fill:none;stroke:#ff9500;stroke-width:var(--border-w);stroke-linecap:round;stroke-linejoin:round;vector-effect:non-scaling-stroke;opacity:0;transition:opacity var(--t-sync) ease-in-out}
  .drop.processing .progressPath{opacity:1}

  .switch{position:relative;display:inline-flex;align-items:center;width:42px;height:24px;flex:0 0 auto}
  .switch input{opacity:0;width:0;height:0}
  .switch .slider{position:absolute;inset:0;background:rgba(255,255,255,.35);border-radius:999px;transition:all var(--t-sync) ease-in-out}
  .switch .slider::before{content:"";position:absolute;width:18px;height:18px;left:3px;top:3px;background:#000;border-radius:50%;transition:all var(--t-sync) ease-in-out}
  .switch input:checked + .slider{background:#fff}
  .switch input:checked + .slider::before{transform:translateX(18px)}

  .drawer{
    position:absolute;
    left:var(--drawer-inset); right:var(--drawer-inset); bottom:var(--drawer-inset);
    z-index:6; display:none; background:rgba(0,0,0,.86);
    border-radius:calc(var(--drop-radius) - 16px);
    padding:var(--drawer-pad);
    transition:opacity var(--t-sync) ease-in-out,transform var(--t-sync) ease-in-out;
    max-height:calc(100% - (var(--drawer-inset)*2));
    overflow:auto;
  }
  @media (max-width:420px){
    .drawer{ border-radius:calc(var(--drop-radius) - 12px); }
  }
  .drawer.show{display:block}
  .drawer .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .drawer h2{margin:0;font-size:16px;font-weight:800;text-align:left}
  .drawer h2.gradText{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:220% 220%;-webkit-background-clip:text;background-clip:text;color:transparent}
  .drawer .close{background:transparent;border:0;color:#fff;font-weight:800;font-size:18px;cursor:pointer;line-height:1;transition:all var(--t-sync) ease-in-out}
  .drawer .close:hover{opacity:.85;transform:rotate(6deg)}

  .cols{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr;gap:var(--cols-gap);align-items:start}
  @media (max-width:1100px){.cols{grid-template-columns:1fr 1fr}}
  @media (max-width:800px){.cols{grid-template-columns:1fr}}
  .group{border:0;border-radius:10px;padding:10px 0}
  .group + .group{margin-top:var(--group-gap)}
  .group .title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .group .glabel{font-weight:800;font-size:13px;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  .group .glabel.gradText{background:linear-gradient(45deg,#00ffd5,#6af0ff,#8d8aff,#ff77e1,#ffc76a);background-size:220% 220%;-webkit-background-clip:text;background-clip:text;color:transparent}
  .g1{display:grid;grid-template-columns:1fr;gap:10px;align-items:center}
  .tool{display:flex;align-items:center;justify-content:space-between;gap:10px; position:relative}
  .drawer label{font-size:13px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}
  .drawer input[type="range"]{-webkit-appearance:none;appearance:none;width:var(--range-w);height:2px;background:rgba(255,255,255,.35);border-radius:0;outline:none;transition:all var(--t-sync) ease-in-out}
  .drawer input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:#fff;border:0;border-radius:50%;cursor:pointer}
  .drawer input[type="range"]::-moz-range-thumb{width:14px;height:14px;background:#fff;border:0;border-radius:50%;cursor:pointer}
  .drawer input[type="range"]::-moz-range-track{height:2px;background:rgba(255,255,255,.35);border:0;border-radius:0}
  .drawer select{height:32px;background:#000;color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:8px;padding:0 8px;transition:all var(--t-sync) ease-in-out;max-width:100%}

  .gtools{
    display:flex; gap:6px; align-self:end; justify-self:end;
    grid-column: -2 / -1;
  }
  @media (max-width:800px){
    .gtools{grid-column: 1 / -1; justify-self:end; margin-top:8px;}
  }
  .gtools .btn{height:36px;font-size:16px;padding:0 12px;border-radius:10px}

  .minmax{display:none;position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);pointer-events:none}
  .minmax span{position:absolute;font-size:10px;opacity:.7}
  .bubble{display:none; position:absolute; font-size:8px; background:rgba(0,0,0,.7); padding:2px 4px; border-radius:6px; pointer-events:none}
  body.debugOn .minmax, body.debugOn .bubble{display:block}

  .shield{position:absolute;inset:0;z-index:10;display:none;cursor:progress}
  .drop.processing .shield{display:block;pointer-events:auto}

  #picker{display:none}
</style>
</head>
<body>
  <div class="drop" id="drop" aria-label="Drop to flashify">
    <div class="bg">
      <img id="ph" alt="" decoding="async" />
      <canvas id="live"></canvas>
    </div>

    <div class="frame" aria-hidden="true">
      <svg id="frameSVG" viewBox="0 0 100 100" preserveAspectRatio="none">
        <path id="dashPath" class="dashPath" d=""/>
        <path id="progressPath" class="progressPath" d=""/>
      </svg>
    </div>

    <div class="center">
      <h1 id="title" class="busy">
        Loading <span class="nowrap"><span class="dots"><span>.</span><span>.</span><span>.</span></span></span>
      </h1>

      <div class="actions hidden" id="actions">
        <a id="download" class="btn" href="#" download="">
          <span class="label">Download flashy GIF <span class="nowrap"><span class="dots"><span>.</span><span>.</span><span>.</span></span></span></span>
        </a>
        <div class="menu" id="menu">
          <button id="chev" class="btn" aria-haspopup="true" aria-expanded="false" title="More options"><span class="chev">‚ñæ</span></button>
          <div class="panel" id="panel">
            <div class="item" id="optOrig"><span class="label">Download flashy GIF in original size <span class="nowrap"><span class="dots"><span>.</span><span>.</span><span>.</span></span></span></span></div>
            <div class="item" id="optShare"><span class="label">Share flashy GIF <span class="nowrap"><span class="dots"><span>.</span><span>.</span><span>.</span></span></span></span></div>
          </div>
        </div>
      </div>

      <div id="subline" class="subline hidden" title="Open controls">Adjust flashyness ‚Ä¶</div>
    </div>

    <div class="bottomUI">
      <div id="toast" class="toast"></div>
      <div class="feedback hidden" id="feedback">
        <span>Do you like it?</span>
        <button class="iconbtn" id="thumbUp" aria-pressed="false" title="Like">
          <svg viewBox="0 0 24 24"><path d="M2 21h4V9H2v12zM22 10a2 2 0 0 0-2-2h-6.31l.95-4.57.02-.2a1.5 1.5 0 0 0-.44-1.06L13 1 6.59 7.41A2 2 0 0 0 6 8.83V19a2 2 0 0 0 2 2h9a2 2 0 0 0 1.98-1.75l1-7A2 2 0 0 0 22 10z"/></svg>
        </button>
        <button class="iconbtn" id="thumbDown" aria-pressed="false" title="Dislike">
          <svg viewBox="0 0 24 24"><path d="M22 3h-4v12h4V3zM2 14a2 2 0 0 0 2 2h6.31l-.95 4.57-.02.2c0 .4.16.78.44 1.06L11 23l6.41-6.41A2 2 0 0 0 18 15.17V5a2 2 0 0 0-2-2H7a2 2 0 0 0-1.98 1.75l-1 7A2 2 0 0 0 2 14z"/></svg>
        </button>
      </div>
    </div>

    <div class="drawer" id="drawer">
      <div class="bar">
        <h2 class="gradText">Flashyness</h2>
        <button class="close" id="closeDrawer" aria-label="Close">‚úï</button>
      </div>

      <div class="cols" id="cols">
        <!-- Global -->
        <section class="group" id="group-global">
          <div class="g1">
            <div class="tool"><label for="cSpeed" title="Speed">Speed</label><input id="cSpeed" type="range" min="0.1" max="2" step="0.05" value="0.55"></div>
            <div class="tool"><label for="cZoom" title="Zoom">Zoom</label><input id="cZoom" type="range" min="0" max="8" step="0.5" value="3"></div>
            <div class="tool"><label for="cWobble" title="Wobble">Wobble</label><input id="cWobble" type="range" min="0" max="12" step="1" value="9"></div>
            <div class="tool"><label for="cRotate" title="Rotate">Rotate</label><input id="cRotate" type="range" min="0" max="6" step="0.5" value="1.5"></div>
            <div class="tool"><label for="cFPS" title="FPS">FPS</label><input id="cFPS" type="range" min="6" max="20" step="1" value="13"></div>
            <div class="tool"><label for="cSecs" title="Seconds">Seconds</label><input id="cSecs" type="range" min="1" max="3" step="0.1" value="1.7"></div>
          </div>
        </section>

        <!-- Overlay self -->
        <section class="group" id="overlayGroup">
          <div class="title">
            <span class="glabel gradText" title="Overlay self">Overlay self</span>
            <label class="switch" for="cOverlay"><input id="cOverlay" type="checkbox" checked><span class="slider"></span></label>
          </div>
          <div class="g1">
            <div class="tool"><label for="cOvOp" title="Opacity">Opacity</label><input id="cOvOp" type="range" min="0" max="1" step="0.05" value="0.55"></div>
            <div class="tool"><label for="cOvOff" title="Offset">Offset</label><input id="cOvOff" type="range" min="-30" max="30" step="1" value="10"></div>
            <div class="tool"><label for="cBlend" title="Blend mode">Blend</label>
              <select id="cBlend" title="Blend mode">
                <option value="multiply" selected>multiply</option>
                <option value="screen">screen</option><option value="lighten">lighten</option>
                <option value="overlay">overlay</option><option value="soft-light">soft-light</option><option value="normal">normal</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Gradient + Flash -->
        <section class="group" id="ggGroup">
          <div class="title">
            <span class="glabel gradText" title="Gradient overlay">Gradient overlay</span>
            <label class="switch" for="cGrad"><input id="cGrad" type="checkbox" checked><span class="slider"></span></label>
          </div>
          <div class="g1">
            <div class="tool"><label for="cGradOp" title="Opacity">Opacity</label><input id="cGradOp" type="range" min="0" max="1" step="0.05" value="0.45"></div>
          </div>

          <div class="title" style="margin-top:12px">
            <span class="glabel gradText" title="Flash">Flash</span>
            <label class="switch" for="cFlash"><input id="cFlash" type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="g1">
            <div class="tool"><label for="cFlStr" title="Strength">Strength</label><input id="cFlStr" type="range" min="0" max="1" step="0.05" value="0.35"></div>
            <div class="tool"><label for="cFlFreq" title="Frequency">Frequency</label><input id="cFlFreq" type="range" min="0.5" max="6" step="0.5" value="2.5"></div>
          </div>
        </section>

        <!-- Liquidify + Glitter -->
        <section class="group" id="liqGroup">
          <div class="title">
            <span class="glabel gradText" title="Liquidify">Liquidify</span>
            <label class="switch" for="cLiquid"><input id="cLiquid" type="checkbox" checked><span class="slider"></span></label>
          </div>
          <div class="g1">
            <div class="tool"><label for="cLiqAmp" title="Amplitude (px)">Amplitude (px)</label><input id="cLiqAmp" type="range" min="0" max="12" step="0.5" value="8.5"></div>
            <div class="tool"><label for="cLiqFreq" title="Frequency">Frequency</label><input id="cLiqFreq" type="range" min="0.5" max="6" step="0.5" value="1"></div>
            <div class="tool"><label for="cLiqSrc" title="Ripple sources">Ripple sources</label><input id="cLiqSrc" type="range" min="1" max="4" step="1" value="2"></div>
          </div>

          <div class="title" style="margin-top:12px">
            <span class="glabel gradText" title="Glitter">Glitter</span>
            <label class="switch" for="cGlitter"><input id="cGlitter" type="checkbox" checked><span class="slider"></span></label>
          </div>
          <div class="g1">
            <div class="tool"><label for="cGltAmt" title="Amount">Amount</label><input id="cGltAmt" type="range" min="0" max="120" step="2" value="50"></div>
          </div>
        </section>

        <!-- Glitch -->
        <section class="group" id="gltGroup">
          <div class="title">
            <span class="glabel gradText" title="Glitch">Glitch</span>
            <label class="switch" for="cGlitch"><input id="cGlitch" type="checkbox"><span class="slider"></span></label>
          </div>
          <div class="g1">
            <div class="tool"><label for="cGltInt" title="Intensity">Intensity</label><input id="cGltInt" type="range" min="0" max="20" step="1" value="6"></div>
            <div class="tool"><label for="cGltAmp" title="Shift (px)">Shift (px)</label><input id="cGltAmp" type="range" min="0" max="40" step="1" value="12"></div>
            <div class="tool"><label for="cGltFreq" title="Frequency">Frequency</label><input id="cGltFreq" type="range" min="0.5" max="6" step="0.5" value="3"></div>
          </div>
        </section>

        <div class="gtools">
          <button id="btnRandom" class="btn btnGhost btn--sm" title="Randomize parameters"><span class="label">Randomize</span></button>
          <button id="btnReset"  class="btn btnGhost btn--sm" title="Reset"><span class="label">Reset</span></button>
        </div>
      </div>
    </div>

    <div class="shield" id="shield" aria-hidden="true"></div>
    <input id="picker" type="file" accept="image/*" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const CFG={IG_SIZE:1080,QUALITY:15, MAX_MB:15};
  const DEFAULT_PARAMS={
    speed:0.55, zoomPct:3, wobble:9, rotate:1.5, fps:13, secs:1.7,
    overlay:true, ovOpacity:0.55, ovOffset:10, blend:'multiply',
    grad:true, gradOp:0.45,
    glitter:true, glitAmt:50,
    liquid:true, liqAmp:8.5, liqFreq:1, liqSrc:2,
    glitch:false, glitchInt:6, glitchAmp:12, glitchFreq:3,
    flash:false, flashStrength:0.35, flashFreq:2.5
  };

  const S={
    file:null,srcURL:null,bmp:null,origNameBase:'flashy',
    params:{...DEFAULT_PARAMS},
    workerURL:null,liveRAF:0,controls:false,menu:false,phHidden:false,
    busy:false, precomputing:false,
    cache:{key:null,sqBlob:null,origBlob:null,sqURL:null,origURL:null,params:null,bmpSig:null},
    preTimer:null,
    hasUserImage:false,
    mobile:false
  };

  const $=id=>document.getElementById(id);
  const drop=$('drop'), picker=$('picker'), ph=$('ph'), live=$('live'), ctx=live.getContext('2d',{willReadFrequently:true});
  const title=$('title'), actions=$('actions'), subline=$('subline');
  const dl=$('download'), menu=$('menu'), chev=$('chev'), optOrig=$('optOrig'), optShare=$('optShare');
  const drawer=$('drawer'), closeDrawer=$('closeDrawer');
  const dash=$('dashPath'), prog=$('progressPath'), svg=$('frameSVG');
  const feedback=$('feedback'), toast=$('toast'), shield=$('shield');

  const log=(...a)=>console.log('[flashify]',...a), err=(...a)=>console.error('[flashify]',...a);
  const raf=()=>new Promise(r=>requestAnimationFrame(r));
  const idle=(fn)=>{ if('requestIdleCallback' in window) requestIdleCallback(fn,{timeout:1000}); else setTimeout(fn,600); };

  function detectMobile(){
    S.mobile = (window.matchMedia && (matchMedia('(pointer: coarse)').matches || matchMedia('(max-width: 480px)').matches));
  }

  function fitCanvasTo(el,cv){
    const r=el.getBoundingClientRect();const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
    cv.width=Math.floor(r.width*dpr); cv.height=Math.floor(r.height*dpr);
    cv.style.width=r.width+'px'; cv.style.height=r.height+'px';
    const x=cv.getContext('2d');
    x.setTransform(dpr,0,0,dpr,0,0); x.imageSmoothingEnabled=true; try{x.imageSmoothingQuality='high'}catch{};
    cv._w=r.width; cv._h=r.height;
  }
  const cover=(W,H,iw,ih)=>Math.max(W/iw,H/ih);
  const effSecs=(p=S.params)=> p.secs/Math.max(0.1,p.speed);
  const baseNoExt=n=>{if(!n)return'image';const m=n.match(/^(.*?)(\.[^.]+)?$/);return (m?m[1]:n).replace(/[\/\\?%*:|"<>]/g,'-').replace(/\s+/g,'_')}
  function humanStamp(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}-${p(d.getMinutes())}-${p(d.getSeconds())}`;}
  const fileStamp=sfx=>`${S.origNameBase}_flashy_${humanStamp()}${sfx?`-${sfx}`:''}.gif`;

  let pathLen=0;
  function buildBorder(){
    const r=drop.getBoundingClientRect(); const W=Math.round(r.width), H=Math.round(r.height);
    const sw=parseFloat(getComputedStyle(dash).strokeWidth)||4; const inset=sw/2, Rfull=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--drop-radius'))||48, R=Math.max(0,Rfull-inset);
    const d=[`M ${R+inset} ${inset}`,`H ${W-R-inset}`,`A ${R} ${R} 0 0 1 ${W-inset} ${R+inset}`,`V ${H-R-inset}`,`A ${R} ${R} 0 0 1 ${W-R-inset} ${H-inset}`,`H ${R+inset}`,`A ${R} ${R} 0 0 1 ${inset} ${H-R-inset}`,`V ${R+inset}`,`A ${R} ${R} 0 0 1 ${R+inset} ${inset}`,`Z`].join(' ');
    svg.setAttribute('viewBox',`0 0 ${W} ${H}`); dash.setAttribute('d',d); prog.setAttribute('d',d);
    try{ pathLen=prog.getTotalLength(); prog.style.strokeDasharray=`${pathLen}`; prog.style.strokeDashoffset=`${pathLen}`; }catch{}
  }
  const setBorderProgress=p=>{ if(!pathLen) return; prog.style.strokeDashoffset=`${(1-p)*pathLen}` }

  const ctrlIds=['cSpeed','cZoom','cWobble','cRotate','cFPS','cSecs','cOverlay','cOvOp','cOvOff','cBlend','cGrad','cGradOp','cGlitter','cGltAmt','cLiquid','cLiqAmp','cLiqFreq','cLiqSrc','cGlitch','cGltInt','cGltAmp','cGltFreq','cFlash','cFlStr','cFlFreq'];

  function writeControls(){
    const p=S.params, set=(id,v)=>{const el=$(id); if(!el)return; if(el.type==='checkbox') el.checked=!!v; else if(el.tagName==='SELECT') el.value=v; else el.value=v;};
    set('cSpeed',p.speed);set('cZoom',p.zoomPct);set('cWobble',p.wobble);set('cRotate',p.rotate);set('cFPS',p.fps);set('cSecs',p.secs);
    set('cOverlay',p.overlay);set('cOvOp',p.ovOpacity);set('cOvOff',p.ovOffset);set('cBlend',p.blend);
    set('cGrad',p.grad);set('cGradOp',p.gradOp);
    set('cGlitter',p.glitter);set('cGltAmt',p.glitAmt);
    set('cLiquid',p.liquid);set('cLiqAmp',p.liqAmp);set('cLiqFreq',p.liqFreq);set('cLiqSrc',p.liqSrc);
    set('cGlitch',p.glitch);set('cGltInt',p.glitchInt);set('cGltAmp',p.gltAmp);set('cGltFreq',p.gltFreq);
    set('cFlash',p.flash);set('cFlStr',p.flashStrength);set('cFlFreq',p.flashFreq);
    updateRangeDecorations();
  }
  function saveParams(){ try{localStorage.setItem('flashify.params.v30',JSON.stringify(S.params))}catch{} }
  function loadParams(){ try{const raw=localStorage.getItem('flashify.params.v30'); if(raw) Object.assign(S.params,JSON.parse(raw)||{});}catch{} writeControls(); }
  function onParams(){
    const g=id=>$(id), p=S.params;
    p.speed=+g('cSpeed').value; p.zoomPct=+g('cZoom').value; p.wobble=+g('cWobble').value; p.rotate=+g('cRotate').value; p.fps=+g('cFPS').value; p.secs=+g('cSecs').value;
    p.overlay=g('cOverlay').checked; p.ovOpacity=+g('cOvOp').value; p.ovOffset=+g('cOvOff').value; p.blend=g('cBlend').value;
    p.grad=g('cGrad').checked; p.gradOp=+g('cGradOp').value;
    p.glitter=g('cGlitter').checked; p.glitAmt=+g('cGltAmt').value;
    p.liquid=g('cLiquid').checked; p.liqAmp=+g('cLiqAmp').value; p.liqFreq=+g('cLiqFreq').value; p.liqSrc=+g('cLiqSrc').value;
    p.glitch=g('cGlitch').checked; p.glitchInt=+g('cGltInt').value; p.glitchAmp=+g('cGltAmp').value; p.glitchFreq=+g('cGltFreq').value;
    p.flash=g('cFlash').checked; p.flashStrength=+g('cFlStr').value; p.flashFreq=+g('cFlFreq').value;
    saveParams(); updateRangeDecorations();
    invalidateCache(); schedulePrecompute();
    if(S.bmp) drawLive(performance.now()/1000);
  }
  ctrlIds.forEach(id=>{
    const el=$(id); el.addEventListener('input',onParams,{passive:true});
    el.addEventListener('change',()=>{onParams(); flashFx();},{passive:true});
  });

  function attachDecorations(){
    document.querySelectorAll('.tool').forEach(tool=>{
      const r=tool.querySelector('input[type="range"]'); if(!r) return;
      if(tool.querySelector('.minmax')) return;
      const mm=document.createElement('div'); mm.className='minmax';
      const a=document.createElement('span'); a.className='mmA';
      const b=document.createElement('span'); b.className='mmB';
      mm.appendChild(a); mm.appendChild(b);
      const bub=document.createElement('div'); bub.className='bubble';
      tool.appendChild(mm); tool.appendChild(bub);
      r._mmA=a; r._mmB=b; r._bub=bub; r._tool=tool;
      r.addEventListener('input',()=>updateRangeDecoration(r));
    });
  }
  function updateRangeDecoration(r){
    if(!(r && r._mmA && r._mmB && r._bub && r._tool)) return;
    const tool=r._tool;
    const toolRect=tool.getBoundingClientRect();
    const rect=r.getBoundingClientRect();
    const min=+r.min, max=+r.max, val=+r.value;
    const pct=(val-min)/(max-min);

    const startX = rect.left - toolRect.left;
    const endX   = rect.right - toolRect.left;
    const centerY = (rect.top - toolRect.top) + rect.height/2;

    r._mmA.textContent=min; r._mmA.style.left=(startX-4)+'px'; r._mmA.style.top=centerY+'px'; r._mmA.style.transform='translate(-100%,-50%)';
    r._mmB.textContent=max; r._mmB.style.left=(endX+4)+'px';   r._mmB.style.top=centerY+'px'; r._mmB.style.transform='translate(0,-50%)';

    const handleX = startX + pct*rect.width;
    r._bub.textContent=val;
    r._bub.style.left=handleX+'px';
    r._bub.style.top=(rect.top - toolRect.top - 6)+'px';
    r._bub.style.transform='translate(-50%,-100%)';
  }
  function updateRangeDecorations(){ document.querySelectorAll('input[type="range"]').forEach(updateRangeDecoration); }
  document.addEventListener('keydown',e=>{ if(S.busy) return; if(e.key && e.key.toLowerCase()==='d'){ document.body.classList.toggle('debugOn'); } });

  function setTitle(st){
    const idleText = S.mobile
      ? 'Tap to flashify <span class="nowrap">‚Ä¶ <span class="emoji">‚ö°Ô∏è</span></span>'
      : 'Drop to flashify <span class="nowrap">‚Ä¶ <span class="emoji">‚ö°Ô∏è</span></span>';
    if(st==='loading'){
      title.classList.add('busy');
      title.innerHTML=`Loading <span class="nowrap"><span class="dots"><span>.</span><span>.</span><span>.</span></span></span>`;
    }
    else if(st==='processing'){
      title.classList.add('busy');
      title.innerHTML=`Flashifying <span class="nowrap"><span class="dots"><span>.</span><span>.</span><span>.</span></span> <span class="emoji">‚ö°Ô∏è</span></span>`;
    }
    else{
      title.classList.remove('busy');
      title.innerHTML=idleText;
    }
  }

  function openMenu(){if(S.busy || !S.hasUserImage) return; menu.classList.add('open');chev.setAttribute('aria-expanded','true');S.menu=true}
  function closeMenu(){menu.classList.remove('open');chev.setAttribute('aria-expanded','false');S.menu=false}
  document.getElementById('chev').addEventListener('click',e=>{if(S.busy || !S.hasUserImage) return; e.stopPropagation();S.menu?closeMenu():openMenu()});
  document.addEventListener('click',e=>{if(!menu.contains(e.target)) closeMenu()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape') closeMenu()});

  function toggleControls(force){ if(S.busy) return; const n=force===true?true:force===false?false:!S.controls;S.controls=n;drawer.classList.toggle('show',S.controls)}
  document.addEventListener('keydown',e=>{if(S.busy) return; if(e.key&&e.key.toLowerCase()==='f') toggleControls()});
  $('subline').addEventListener('click',e=>{if(S.busy) return; e.stopPropagation();toggleControls()});
  $('closeDrawer').addEventListener('click',()=>toggleControls(false));

  /* ---------- Feedback / Toast ---------- */
  let vote=null, toastTimer=null;
  function hideToast(){ toast.classList.remove('show'); toast.innerHTML=''; }
  function scheduleToastAutoclose(ms=5000){ if(toastTimer){ clearTimeout(toastTimer); toastTimer=null; } toastTimer=setTimeout(()=>{ hideToast(); }, ms); }
  function showThanksToast(){ toast.classList.add('narrow'); toast.innerHTML = `<button class="x" aria-label="Close">‚úï</button><div>Thanks for your feedback! üôåüèΩ</div>`; toast.querySelector('.x').addEventListener('click', (e)=>{e.stopPropagation(); hideToast();}); toast.classList.add('show'); scheduleToastAutoclose(5000); }
  function showSavedToast(){ toast.classList.remove('narrow'); toast.innerHTML = `<button class="x" aria-label="Close">‚úï</button><div>Saved to your Downloads folder.</div>`; toast.querySelector('.x').addEventListener('click', (e)=>{e.stopPropagation(); hideToast();}); toast.classList.add('show'); scheduleToastAutoclose(4000); }
  $('thumbUp').addEventListener('click',e=>{ if(S.busy) return; e.stopPropagation(); const was=(vote==='up'); vote=was?null:'up'; e.currentTarget.classList.toggle('active',vote==='up'); $('thumbDown').classList.remove('active'); hideToast(); if(vote==='up') showThanksToast(); });
  $('thumbDown').addEventListener('click',e=>{ if(S.busy) return; e.stopPropagation(); const was=(vote==='down'); vote=was?null:'down'; e.currentTarget.classList.toggle('active',vote==='down'); $('thumbUp').classList.remove('active'); hideToast(); if(vote==='down'){ const to='jonas.a.schmidt+flashify@gmail.com'; const subj=`Flashify feedback ‚Äî negative ‚Äî ${humanStamp()}`; const body=`What's wrong?\n\nParams (JSON):\n${JSON.stringify(S.params,null,2)}\n\nUser agent:\n${navigator.userAgent}`; location.href=`mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`; } });

  /* ---------- Rendering pipeline (unver√§ndert) ---------- */
  let stage=null, liq=null, pad=null, padCtx=null;
  function ensureStage(W,H){ if(!stage){stage=document.createElement('canvas');} if(!liq){liq=document.createElement('canvas');} if(stage.width!==W||stage.height!==H){stage.width=W;stage.height=H;} if(liq.width!==W||liq.height!==H){liq.width=W;liq.height=H;} }
  function ensurePad(W,H,p){const needW=W+2*p, needH=H+2*p; if(!pad || pad.width!==needW || pad.height!==needH){pad=document.createElement('canvas'); pad.width=needW; pad.height=needH; padCtx=pad.getContext('2d',{willReadFrequently:true}); padCtx.imageSmoothingEnabled=true; try{padCtx.imageSmoothingQuality='high'}catch{}}}
  function buildPadFromStage(p){const W=stage.width,H=stage.height; padCtx.clearRect(0,0,pad.width,pad.height); padCtx.drawImage(stage,p,p);
    padCtx.drawImage(stage,0,0,1,H, 0,p, p,H); padCtx.drawImage(stage,W-1,0,1,H, p+W,p, p,H);
    padCtx.drawImage(stage,0,0,W,1, p,0, W,p); padCtx.drawImage(stage,0,H-1,W,1, p,p+H, W,p);
    padCtx.drawImage(stage,0,0,1,1, 0,0, p,p); padCtx.drawImage(stage,W-1,0,1,1, p+W,0, p,p);
    padCtx.drawImage(stage,0,H-1,1,1, 0,p+H, p,p); padCtx.drawImage(stage,W-1,H-1,1,1, p+W,p+H, p,p); }

  function drawStage(ctx,W,H,t,params,bmp){
    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,W,H); ctx.save();
    const iw=bmp.width||bmp.naturalWidth, ih=bmp.height||bmp.naturalHeight;
    const base=cover(W,H,iw,ih);
    const z=1+(params.zoomPct/100)*(0.5+0.5*Math.sin(t*2*Math.PI));
    const sc=base*z;
    const rot=(params.rotate||0)*Math.sin(t*2*Math.PI)*Math.PI/180;
    const wob=params.wobble, jx=Math.sin(t*2*Math.PI)*wob, jy=Math.cos(t*2*Math.PI)*wob;
    ctx.translate(W/2,H/2); ctx.rotate(rot);
    const dw=iw*sc, dh=ih*sc;
    ctx.drawImage(bmp,-dw/2 + jx,-dh/2 + jy,dw,dh);
    if(params.overlay){
      ctx.globalAlpha=params.ovOpacity; ctx.globalCompositeOperation=params.blend||'multiply';
      const off=params.ovOffset||8;
      ctx.drawImage(bmp,-dw/2 + jx + off*Math.sin(t*4*Math.PI), -dh/2 + jy + off*Math.cos(t*3*Math.PI), dw,dh);
      ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
    }
    ctx.restore();
  }
  function applyExtras(ctx,W,H,t,params,srcCanvas){
    if(params.grad){
      const diag=Math.hypot(W,H), R0=Math.min(W,H)*.06, R1=0.85*diag;
      const g=ctx.createRadialGradient(W/2,H/2,R0, W/2,H/2,R1);
      const hue=(t*360)|0, op=(params.gradOp==null?0.45:Math.max(0,Math.min(1,params.gradOp)));
      g.addColorStop(0,`hsla(${(hue+60)%360},100%,60%,${op})`);
      g.addColorStop(1,`hsla(${(hue+200)%360},100%,20%,${op*0.8})`);
      ctx.save(); ctx.globalCompositeOperation='screen'; ctx.fillStyle=g; ctx.fillRect(0,0,W,H); ctx.restore();
    }
    if(params.flash && ((t*params.flashFreq*2)%1)>0.92){ctx.save();ctx.globalCompositeOperation='screen';ctx.fillStyle=`rgba(255,255,255,${params.flashStrength})`;ctx.fillRect(0,0,W,H);ctx.restore()}
    if(params.glitter){
      ctx.save(); ctx.globalCompositeOperation='screen';
      const K=Math.max(0,Math.round(params.glitAmt||0));
      for(let k=0;k<K;k++){
        const ax=Math.random()*W, ay=Math.random()*H, rr=Math.random()*1.6+0.2;
        ctx.fillStyle=`rgba(255,255,${200+((Math.random()*55)|0)},0.75)`;
        ctx.beginPath(); ctx.arc(ax,ay,rr,0,6.283); ctx.fill();
      }
      ctx.restore();
    }
    if(params.glitch && ((t*params.glitchFreq*10)%1)>0.86){
      const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H;
      const tctx=tmp.getContext('2d',{willReadFrequently:true});
      tctx.drawImage(srcCanvas,0,0,W,H);
      const n=Math.round(params.glitchInt);
      for(let s=0;s<n;s++){
        const y=Math.floor(Math.random()*H),th=Math.max(1,Math.floor(Math.random()*Math.max(2,H*0.025))),dx=Math.floor((Math.random()-0.5)*2*params.glitchAmp);
        ctx.drawImage(tmp,0,y,W,th,dx,y,W,th);
      }
    }
  }

  function startPreview(){ if(S.liveRAF) cancelAnimationFrame(S.liveRAF); let t0=performance.now(); const loop=()=>{drawLive((performance.now()-t0)/1000); S.liveRAF=requestAnimationFrame(loop)}; loop(); }
  function drawLive(time){
    const W=live._w||live.width, H=live._h||live.height; ctx.clearRect(0,0,W,H);
    if(!S.bmp) return;
    ensureStage(W,H);
    const p=S.params, T=effSecs(p), t=(time/T)%1;
    const sctx=stage.getContext('2d',{willReadFrequently:true}); sctx.imageSmoothingEnabled=true; try{sctx.imageSmoothingQuality='high'}catch{}
    const lctx=liq.getContext('2d',{willReadFrequently:true}); lctx.imageSmoothingEnabled=true; try{lctx.imageSmoothingQuality='high'}catch{}

    drawStage(sctx,W,H,t,p,S.bmp);
    lctx.setTransform(1,0,0,1,0,0); lctx.clearRect(0,0,W,H);
    if(p.liquid){
      const padSize=Math.ceil(p.liqAmp*3 + 12);
      ensurePad(W,H,padSize); buildPadFromStage(padSize);
      const step=2;
      for(let y=0;y<H;y+=step){
        const yn=y/H;
        let v=0; const srcs=Math.max(1,Math.round(p.liqSrc));
        for(let s=1;s<=srcs;s++){ v+=Math.sin(yn*(p.liqFreq*s)*2*Math.PI + (time/T)*2*Math.PI*s)/srcs; }
        const dx=v*p.liqAmp;
        const sx=Math.max(0,Math.min(pad.width-W,Math.round(padSize - dx)));
        lctx.drawImage(pad, sx, y+padSize, W, step, 0, y, W, step);
      }
    }else{
      lctx.drawImage(stage,0,0);
    }
    ctx.drawImage(liq,0,0);
    applyExtras(ctx,W,H,t,p, live);
    if(!S.phHidden){ ph.classList.remove('show'); ph.classList.add('hide'); S.phHidden=true; }
  }

  async function workerURL(){ if(S.workerURL) return S.workerURL; const res=await fetch('https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'); const b=await res.blob(); S.workerURL=URL.createObjectURL(b); return S.workerURL; }
  async function encodeGIF(W,H, params, bmp, onProgress){
    const T=effSecs(params); let frames=Math.max(6,Math.round(params.fps*T)); const delay=Math.max(10,Math.round((T*1000)/frames)); frames=Math.max(2,Math.round((T*1000)/delay));
    const gif=new GIF({workers:3,quality:CFG.QUALITY,width:W,height:H,workerScript:await workerURL(),repeat:0});
    if(onProgress){gif.on('progress',q=>setBorderProgress(0.25+0.75*q)); setBorderProgress(0.1);}
    const done=new Promise((res,rej)=>{gif.on('finished',b=>res(b));gif.on('error',rej)});

    const S1=document.createElement('canvas'); S1.width=W; S1.height=H; const sctx=S1.getContext('2d',{willReadFrequently:true}); sctx.imageSmoothingEnabled=true;
    const L1=document.createElement('canvas'); L1.width=W; L1.height=H; const lctx=L1.getContext('2d',{willReadFrequently:true}); lctx.imageSmoothingEnabled=true;
    const C1=document.createElement('canvas'); C1.width=W; C1.height=H; const cctx=C1.getContext('2d',{willReadFrequently:true}); cctx.imageSmoothingEnabled=true;

    let P=null,Pctx=null,pad=0;
    function ensureP(amount){const need=Math.ceil(amount*3+12), w=W+2*need, h=H+2*need; if(!P||P.width!==w||P.height!==h){P=document.createElement('canvas');P.width=w;P.height=h;Pctx=P.getContext('2d',{willReadFrequently:true});Pctx.imageSmoothingEnabled=true;} pad=need;}
    function buildP(){Pctx.clearRect(0,0,P.width,P.height);Pctx.drawImage(S1,pad,pad);Pctx.drawImage(S1,0,0,1,H,0,pad,pad,H);Pctx.drawImage(S1,W-1,0,1,H,pad+W,pad,pad,H);Pctx.drawImage(S1,0,0,W,1,pad,0,W,pad);Pctx.drawImage(S1,0,H-1,W,1,pad,pad+H,W,pad);Pctx.drawImage(S1,0,0,1,1,0,0,pad,pad);Pctx.drawImage(S1,W-1,0,1,1,pad+W,0,pad,pad);Pctx.drawImage(S1,0,H-1,1,1,0,pad+H,pad,pad);Pctx.drawImage(S1,W-1,H-1,1,1,pad+W,pad+H,pad,pad);}

    for(let i=0;i<frames;i++){
      const t=i/frames;
      drawStage(sctx,W,H,t,params,bmp);
      lctx.setTransform(1,0,0,1,0,0); lctx.clearRect(0,0,W,H);
      if(params.liquid){
        ensureP(params.liqAmp); buildP();
        const step=2;
        for(let y=0;y<H;y+=step){
          const yn=y/H, dx=(function(yN){let v=0;const srcs=Math.max(1,Math.round(params.liqSrc));for(let s=1;s<=srcs;s++){v+=Math.sin(yN*(params.liqFreq*s)*2*Math.PI + t*2*Math.PI*s)/srcs}return v;})(yn)*params.liqAmp;
          const sx=Math.max(0,Math.min(P.width-W,Math.round(pad - dx)));
          lctx.drawImage(P,sx,y+pad,W,step,0,y,W,step);
        }
      } else { lctx.drawImage(S1,0,0); }
      cctx.setTransform(1,0,0,1,0,0); cctx.clearRect(0,0,W,H);
      cctx.drawImage(L1,0,0);
      applyExtras(cctx,W,H,t,params, C1);
      gif.addFrame(cctx,{copy:true,delay});
      if(onProgress){ const pp=0.1+0.15*(i/Math.max(1,frames-1)); setBorderProgress(pp); }
      if(i%4===0) await raf();
    }
    gif.render();
    return await done;
  }

  function setControlsEnabled(on){
    drawer.querySelectorAll('input,select,button').forEach(el=>{ el.disabled=!on; });
  }
  function setProcessing(on){
    S.busy=!!on;
    drop.classList.toggle('processing', S.busy);
    $('download').toggleAttribute('disabled', S.busy || !S.hasUserImage);
    $('chev').toggleAttribute('disabled', S.busy || !S.hasUserImage);
    setControlsEnabled(!S.busy);
    shield.style.pointerEvents = S.busy?'auto':'none';
  }

  async function nativeSave(blob, filename){
    const hasPicker = 'showSaveFilePicker' in window && window.isSecureContext;
    if (hasPicker){
      try{
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{ description:'GIF image', accept: {'image/gif':['.gif']} }]
        });
        const writable = await handle.createWritable();
        await writable.write(blob); await writable.close();
        return 'picker';
      }catch(e){
        if(e && e.name==='AbortError') return 'canceled';
      }
    }
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename||'flashy.gif'; a.rel='noopener';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>{ try{URL.revokeObjectURL(url)}catch{} }, 20000);
    return 'anchor';
  }

  function bmpSig(){
    const iw=S.bmp?.width||S.bmp?.naturalWidth||0, ih=S.bmp?.height||S.bmp?.naturalHeight||0;
    return `${S.origNameBase}:${iw}x${ih}`;
  }
  function paramsSnapshot(){ return JSON.parse(JSON.stringify(S.params)); }
  function paramsKey(p){ return JSON.stringify(p); }
  function signature(p= S.params){ return bmpSig() + '|' + paramsKey(p); }
  function revokeURL(u){ try{ if(u) URL.revokeObjectURL(u);}catch{} }
  function invalidateCache(){
    revokeURL(S.cache.sqURL); revokeURL(S.cache.origURL);
    S.cache={key:null,sqBlob:null,origBlob:null,sqURL:null,origURL:null,params:null,bmpSig:null};
  }
  function canPrecompute(){ const u=S.srcURL||''; return u.startsWith('blob:') || u.startsWith('data:'); }
  function schedulePrecompute(){
    if(S.preTimer){ clearTimeout(S.preTimer); S.preTimer=null; }
    if(!S.bmp || !canPrecompute()) return;
    const key=signature();
    if(S.cache.key===key && S.cache.sqBlob) return;
    S.preTimer=setTimeout(()=>idle(precomputeSquare), 900);
  }
  async function precomputeSquare(){
    if(!S.bmp || S.precomputing || !canPrecompute()) return;
    const key=signature();
    if(S.cache.key===key && S.cache.sqBlob) return;
    S.precomputing=true;
    const snap=paramsSnapshot();
    try{
      const blob = await encodeGIF(CFG.IG_SIZE, CFG.IG_SIZE, snap, S.bmp, false);
      revokeURL(S.cache.sqURL);
      S.cache.key=key; S.cache.params=snap; S.cache.bmpSig=bmpSig();
      S.cache.sqBlob=blob; S.cache.sqURL=URL.createObjectURL(blob);
      log('Precomputed square GIF cached.');
    }catch(e){ err('precompute',e); }
    finally{ S.precomputing=false; }
  }

  async function getSquareBlob(){
    const key=signature();
    if(S.cache.key===key && S.cache.sqBlob) return S.cache.sqBlob;
    const snap=paramsSnapshot();
    const blob = await encodeGIF(CFG.IG_SIZE, CFG.IG_SIZE, snap, S.bmp, true);
    revokeURL(S.cache.sqURL);
    S.cache.key=key; S.cache.params=snap; S.cache.bmpSig=bmpSig();
    S.cache.sqBlob=blob; S.cache.sqURL=URL.createObjectURL(blob);
    return blob;
  }
  async function getOrigBlob(){
    const key=signature();
    if(S.cache.key===key && S.cache.origBlob) return S.cache.origBlob;
    const iw = S.bmp?.width  || S.bmp?.naturalWidth  || 1080;
    const ih = S.bmp?.height || S.bmp?.naturalHeight || 1080;
    const snap=paramsSnapshot();
    const blob = await encodeGIF(iw, ih, snap, S.bmp, true);
    revokeURL(S.cache.origURL);
    if(S.cache.key!==key){ invalidateCache(); S.cache.key=key; S.cache.params=snap; S.cache.bmpSig=bmpSig(); }
    S.cache.origBlob=blob; S.cache.origURL=URL.createObjectURL(blob);
    return blob;
  }

  async function startExport(kind){
    if(S.busy || !S.bmp || !S.hasUserImage) return;
    closeMenu(); setProcessing(true); setTitle('processing');
    try{
      setBorderProgress(0.02);
      const blob = (kind==='sq') ? await getSquareBlob() : await getOrigBlob();
      const filename = (kind==='sq') ? fileStamp('1080') : fileStamp('orig');
      const method = await nativeSave(blob, filename);
      if(method==='anchor'){ showSavedToast(); }
    } catch(e){ err('export failed', e); }
    finally { setBorderProgress(1); setProcessing(false); setTitle('idle'); }
  }

  async function shareSquare(){
    if(!S.bmp || S.busy || !S.hasUserImage) return;
    closeMenu();
    const key=signature();
    if(!(S.cache.key===key && S.cache.sqBlob)){
      setProcessing(true); setTitle('processing'); setBorderProgress(0.02);
      try{ await getSquareBlob(); }catch(e){ err('share pre-encode',e); setProcessing(false); setTitle('idle'); return; }
      setProcessing(false); setTitle('idle'); setBorderProgress(1);
    }
    const filename=fileStamp('1080');
    const file=new File([S.cache.sqBlob], filename, {type:'image/gif'});
    if(navigator.canShare && (()=>{try{return navigator.canShare({files:[file]})}catch{return false}})()){
      try{ await navigator.share({files:[file], title:'Flashify', text:'Made with Flashify ‚ö°Ô∏è'}); }
      catch(e){ /* canceled */ }
    }else{
      const url = URL.createObjectURL(S.cache.sqBlob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>{ try{URL.revokeObjectURL(url)}catch{} }, 20000);
    }
  }

  function overLimit(file){ return file && file.size > CFG.MAX_MB * 1024 * 1024; }
  function guardAndStart(file){
    if(!file) return;
    if(overLimit(file)){
      alert(`Nur Dateien bis max. ${CFG.MAX_MB} MB sind erlaubt.\nAusgew√§hlt: ${(file.size/1048576).toFixed(2)} MB`);
      return;
    }
    start(file);
  }

  dl.addEventListener('click', e=>{ e.preventDefault(); if(S.busy || !S.hasUserImage) return; startExport('sq'); });
  optOrig.addEventListener('click', e=>{ if(S.busy || !S.hasUserImage) return; e.stopPropagation(); startExport('orig'); });
  optShare.addEventListener('click', e=>{ if(S.busy || !S.hasUserImage) return; e.stopPropagation(); shareSquare(); });

  ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); if(S.busy) return; drop.classList.add('drag')}));
  ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); if(S.busy) return; drop.classList.remove('drag')}));
  drop.addEventListener('drop',async e=>{ e.preventDefault(); if(S.busy){return} if(S.menu){closeMenu();return}
    const f=e.dataTransfer?.files?.[0]; guardAndStart(f);
  });
  drop.addEventListener('click',e=>{ if(S.busy){e.preventDefault(); return} if(S.menu){closeMenu();return}
    if(e.target.closest('.actions,.menu,.drawer,.subline,.feedback,.toast')) return; picker.click();
  });
  picker.addEventListener('change',async e=>{const f=e.target.files?.[0]; e.target.value=''; guardAndStart(f);});

  function flashFx(){drop.classList.add('flash'); setTimeout(()=>drop.classList.remove('flash'),520)}

  function cleanURLs(){
    ['sqURL','origURL','srcURL'].forEach(k=>{const u=S.cache[k]||S[k]; if(u) try{URL.revokeObjectURL(u)}catch{}; S.cache[k]=null; S[k]=null});
    S.cache.sqBlob=null; S.cache.origBlob=null;
  }

  async function start(file){
    try{
      S.hasUserImage = true;
      setTitle('loading'); actions.classList.add('hidden'); feedback.classList.add('hidden');
      drop.classList.remove('ready'); setBorderProgress(0); S.phHidden=false; cleanURLs(); invalidateCache();
      S.file=file; S.origNameBase=baseNoExt(file.name||'image');
      S.srcURL=URL.createObjectURL(file); ph.src=S.srcURL; ph.classList.add('show'); ph.classList.remove('hide');
      S.bmp=await createImageBitmap(file).catch(async()=>{const img=new Image(); img.src=S.srcURL; await img.decode(); return img});
      fitCanvasTo(drop,live); startPreview();
      setTitle('idle'); flashFx();
      actions.classList.remove('hidden'); feedback.classList.remove('hidden'); subline.textContent='Adjust flashyness ‚Ä¶'; subline.classList.remove('hidden'); drop.classList.add('ready');
      schedulePrecompute();
    }catch(e){err('start',e); setTitle('idle')}
  }

  async function startFromImageElement(src, nameGuess){
    const img = new Image();
    img.src = src;
    await img.decode();
    const name = nameGuess || (src.split('/').pop() || 'demo.jpg');

    S.hasUserImage = false; // Demo nicht exportieren
    setTitle('loading'); actions.classList.add('hidden'); feedback.classList.add('hidden');
    drop.classList.remove('ready'); setBorderProgress(0); S.phHidden=false; cleanURLs(); invalidateCache();
    S.file=null; S.origNameBase=baseNoExt(name);
    S.srcURL=src; ph.src=S.srcURL; ph.classList.add('show'); ph.classList.remove('hide');
    S.bmp=img;
    fitCanvasTo(drop,live); startPreview();
    setTitle('idle'); flashFx();
    subline.textContent='Adjust flashyness ‚Ä¶'; subline.classList.remove('hidden'); 
    drop.classList.add('ready');
  }

  async function tryLoadDemo(){
    const candidates=['IMG_5230.JPG','IMG_5230.jpg','img_5230.JPG','img_5230.jpg','./IMG_5230.JPG','./IMG_5230.jpg'];
    for(const n of candidates){
      try{
        const url=new URL(n, location.href).toString();
        await startFromImageElement(url, n.replace(/^.*[\\/]/,''));
        log('Demo image (Image.decode) geladen:', n);
        return true;
      }catch(e){}
    }
    log('Kein Demo-Bild gefunden. Lege IMG_5230.JPG neben index.html.');
    return false;
  }

  (async function initApp(){
    detectMobile();
    setTitle('loading');
    loadParams(); fitCanvasTo(drop,live); buildBorder(); attachDecorations();
    await tryLoadDemo();
    setTitle('idle');
    log('Ready. Tap/Click background or drop a file. Press "F" for controls, "D" for debug values.');
  })();

  addEventListener('resize',()=>{
    detectMobile();
    fitCanvasTo(drop,live); buildBorder(); updateRangeDecorations();
    if(!S.busy) setTitle('idle');
    if(S.bmp) drawLive(performance.now()/1000)
  },{passive:true});
});
</script>
</body>
</html>
